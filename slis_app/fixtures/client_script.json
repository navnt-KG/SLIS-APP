[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Soil Sample Collection",
  "enabled": 1,
  "modified": "2026-01-22 16:36:25.065165",
  "module": "Slis App",
  "name": "total package value",
  "script": "frappe.ui.form.on('Soil Sample Collection', {\n    // Trigger calculation if the discount percentage is changed manually\n    discount: function(frm) {\n        calculate_final_price(frm);\n    },\n    \n    test_packages_remove: function(frm) {\n        // Recalculate everything if a row is deleted\n        calculate_final_price(frm);\n    }\n});\n\nfrappe.ui.form.on('test rates CT', {\n    test: function(frm, cdt, cdn) {\n        let row = locals[cdt][cdn];\n        if (row.test) {\n            frappe.db.get_value('Test Rates', row.test, ['rate', 'category', 'description'], (r) => {\n                if (r) {\n                    frappe.model.set_value(cdt, cdn, 'rate', r.rate);\n                    frappe.model.set_value(cdt, cdn, 'category', r.category);\n                    frappe.model.set_value(cdt, cdn, 'description', r.description);\n                    calculate_final_price(frm);\n                }\n            });\n        } else {\n            frappe.model.set_value(cdt, cdn, 'rate', 0);\n            calculate_final_price(frm);\n        }\n    }\n});\n\n// Main logic for Total and Discount\nvar calculate_final_price = function(frm) {\n    let total = 0;\n    \n    // 1. Calculate the base total from child table\n    (frm.doc.test_packages || []).forEach(row => {\n        total += flt(row.rate);\n    });\n    frm.set_value('total_amount', total);\n\n    // 2. Calculate the discount\n    // Formula: Discount Price = Total - (Total * (Discount / 100))\n    let discount_percent = flt(frm.doc.discount);\n    let amount_to_deduct = total * (discount_percent / 100);\n    let final_price = total - amount_to_deduct;\n\n    // 3. Update the field\n    frm.set_value('discount_price', final_price);\n};",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sample Testing",
  "enabled": 0,
  "modified": "2026-01-23 16:38:06.232918",
  "module": "Slis App",
  "name": "test result calc",
  "script": "frappe.ui.form.on('Sample Testing', {\n    refresh: function(frm) {\n        // You can add logic here to hide/show buttons based on workflow\n    }\n});\n\n// Using the exact Child Table Name from your previous message: \"Test Result CT\"\nfrappe.ui.form.on('Test Result CT', {\n    \n    // Trigger when the user types in the observed_value field\n    observed_value: function(frm, cdt, cdn) {\n        calculate_row_result(frm, cdt, cdn);\n    },\n    \n    // Trigger when the user types in the constantfactor field\n    constantfactor: function(frm, cdt, cdn) {\n        calculate_row_result(frm, cdt, cdn);\n    }\n});\n\n// Helper function to perform the math\nvar calculate_row_result = function(frm, cdt, cdn) {\n    let row = locals[cdt][cdn];\n    \n    // Ensure both values exist to avoid NaN errors\n    if (row.observed_value && row.constantfactor) {\n        \n        // Calculation: final_result = observed_value * constantfactor\n        let result = flt(row.observed_value) * flt(row.constantfactor);\n        \n        // Update the final_result field in the specific row\n        frappe.model.set_value(cdt, cdn, 'final_result', result);\n        \n        // Automatically run the interpretation logic\n        run_interpretation_logic(frm, cdt, cdn, result);\n    } else {\n        // Reset to 0 if inputs are cleared\n        frappe.model.set_value(cdt, cdn, 'final_result', 0);\n    }\n};\n\n// Interpretation logic based on soil science standards\nvar run_interpretation_logic = function(frm, cdt, cdn, val) {\n    let row = locals[cdt][cdn];\n    let status = \"\";\n\n    // Example logic for Nitrogen (N)\n    if (row.test_name === \"N\") {\n        if (val < 280) status = \"Low\";\n        else if (val <= 560) status = \"Medium\";\n        else status = \"High\";\n    } \n    // Example logic for Phosphorus (P)\n    else if (row.test_name === \"P\") {\n        if (val < 10) status = \"Low\";\n        else if (val <= 25) status = \"Medium\";\n        else status = \"High\";\n    }\n\n    if (status) {\n        frappe.model.set_value(cdt, cdn, 'interpretation', status);\n    }\n};",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sample Testing",
  "enabled": 1,
  "modified": "2026-01-28 16:14:57.307267",
  "module": "Slis App",
  "name": "new result calc",
  "script": "frappe.ui.form.on('Sample Testing', {\n    refresh: function(frm) {\n        // Workflow button logic can go here\n    }\n});\n\nfrappe.ui.form.on('Test Result CT', {\n    test_name: function(frm, cdt, cdn) {\n        let row = locals[cdt][cdn];\n        if (row.test_name) {\n            // 1. Fetch the scientific labels from your Master\n            frappe.db.get_value('Test Equation Master', {'test_name': row.test_name}, \n                ['formula', 'input_1', 'input_2', 'input_3'], (r) => {\n                if (r) {\n                    // 2. Target the specific row in the Lab Results grid\n                    let grid_row = frm.fields_dict['lab_results'].grid.get_row(cdn);\n                    \n                    // 3. Set the new labels based on your Master data\n                    grid_row.set_field_property('input_1', 'label', r.input_1 || \"Input 1\");\n                    grid_row.set_field_property('input_2', 'label', r.label_2 || \"Input 2\"); // Check if your field is input_2 or label_2\n                    grid_row.set_field_property('input_3', 'label', r.input_3 || \"Input 3\");\n\n                    // 4. Update the formula for calculation\n                    frappe.model.set_value(cdt, cdn, 'formula_cache', r.formula);\n                    \n                    // 5. Force the grid to refresh the UI labels\n                    grid_row.refresh_field('input_1');\n                    grid_row.refresh_field('input_2');\n                    grid_row.refresh_field('input_3');\n                }\n            });\n        }\n    }\n});\n\n    var calculate_dynamic = function(frm, cdt, cdn) {\n    let row = locals[cdt][cdn];\n    if (row.formula_cache) {\n        // Map generic inputs to the variables used in your manual's equations\n        let input_1 = flt(row.input_1); \n        let input_2 = flt(row.input_2);\n        let input_3 = flt(row.input_3);\n\n        try {\n            // Eval runs the string from the Master as a live equation\n            let result = eval(row.formula_cache);\n            frappe.model.set_value(cdt, cdn, 'final_result', result);\n        } catch (e) {\n            console.log(\"Formula Error:\", e);\n        }\n    }\n};",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Soil Sample Collection",
  "enabled": 1,
  "modified": "2026-02-05 15:32:12.793697",
  "module": "Slis App",
  "name": "soil sample to register",
  "script": "frappe.ui.form.on('Soil Sample Collection', {\n    refresh(frm) {\n        if (frm.is_new()) return;\n\n        // ðŸŸ¢ Already created â†’ GO button\n        if (frm.doc.lab_register_created) {\n            frm.add_custom_button(\n                __('Go to Lab Register'),\n                () => {\n                    frappe.set_route('List', 'Lab Register', {\n                        soil_sample_collection: frm.doc.name\n                    });\n                }\n            );\n            return;\n        }\n\n        // ðŸ”µ Not created yet â†’ ADD button\n        if (frm.doc.bulk_samples?.length) {\n            frm.add_custom_button(\n                __('Add to Lab Register'),\n                () => {\n                    frappe.call({\n                        method: 'slis_app.slis_app.doctype.soil_sample_collection.soil_sample_collection.add_to_lab_register',\n                        args: {\n                            docname: frm.doc.name\n                        },\n                        freeze: true,\n                        callback(r) {\n                            if (!r.exc) {\n                                frappe.msgprint(__('Added to Lab Register successfully'));\n                                frm.reload_doc(); // ðŸ” refresh UI\n                            }\n                        }\n                    });\n                }\n            );\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Soil Sample Collection",
  "enabled": 1,
  "modified": "2026-01-06 16:01:33.966770",
  "module": "Slis App",
  "name": "form view",
  "script": "frappe.ui.form.on('Soil Sample Collection', {\n    // 1. Trigger when the form loads\n    refresh: function(frm) {\n        frm.trigger('sample_type');\n    },\n\n    // 2. Trigger whenever the 'sample_type' field is changed\n    sample_type: function(frm) {\n        console.log(\"Sample Type changed to: \" + frm.doc.sample_type);\n\n        // List of Section/Column fieldnames to toggle\n        const specific_columns = [\n            'farmer_sample_section',\n            'consultancy_student_section',\n            'consultancy_department_section',\n            'department_section'\n        ];\n\n        // Hide everything first\n        specific_columns.forEach(col => {\n            frm.set_df_property(col, 'hidden', 1);\n        });\n\n        // Always show common fields\n        frm.set_df_property('common_section', 'hidden', 0);\n        frm.set_df_property('contact_section', 'hidden', 0);\n\n        // Show the relevant section based on selection\n        if (frm.doc.sample_type === 'Farmer') {\n            frm.set_df_property('farmer_sample_section', 'hidden', 0);\n        } \n        else if (frm.doc.sample_type === 'Consultancy Student') {\n            frm.set_df_property('consultancy_student_section', 'hidden', 0);\n        } \n        else if (frm.doc.sample_type === 'Consultancy Departmet') { \n            // Note: Keep the typo 'Departmet' if that is exactly how it is in your \"Options\"\n            frm.set_df_property('consultancy_department_section', 'hidden', 0);\n        } \n        else if (frm.doc.sample_type === 'Department') {\n            frm.set_df_property('department_section', 'hidden', 0);\n        }\n\n        // Force the UI to refresh the hidden/visible state\n        frm.refresh_fields();\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Soil Sample Collection",
  "enabled": 1,
  "modified": "2026-01-06 16:04:32.149844",
  "module": "Slis App",
  "name": "district option",
  "script": "frappe.ui.form.on('Soil Sample Collection', {\n    refresh: function(frm) {\n        console.log(\"Script Loaded: Setting District query...\");\n        \n        frm.set_query('district', function() {\n            console.log(\"District dropdown was clicked!\"); // This triggers when you open the dropdown\n            return {\n                filters: {}\n            };\n        });\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Soil Sample Collection",
  "enabled": 1,
  "modified": "2026-01-07 12:44:41.085743",
  "module": "Slis App",
  "name": "panch dist",
  "script": "frappe.ui.form.on('Soil Sample Collection', {\n    onload: function(frm) {\n        // This will pop up as soon as you open the form\n        // frappe.msgprint(\"Script Loaded: Filter is being applied to Panchayat\");\n\n        frm.set_query('panchayath', function() {\n            return {\n                filters: {\n                    'district': frm.doc.district \n                }\n            };\n        });\n    },\n    district: function(frm) {\n        // This will pop up when you change the District value\n        // frappe.msgprint(\"District changed to: \" + frm.doc.district + \". Clearing Panchayat field.\");\n        \n        frm.set_value('panchayath', '');\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Soil Sample Collection",
  "enabled": 1,
  "modified": "2026-01-08 15:00:27.291308",
  "module": "Slis App",
  "name": "package script",
  "script": "frappe.ui.form.on('Soil Sample Collection', {\n    refresh: function(frm) {\n        // Filter the Child Table search based on Sample Type\n        frm.set_query('test_item', 'test_table', function() {\n            let categories = [];\n            if (frm.doc.sample_type === 'Farmer') {\n                categories = ['Group A', 'Group B'];\n            } else {\n                categories = ['Individual'];\n            }\n            return {\n                filters: [\n                    ['Soil Test Package', 'category', 'in', categories]\n                ]\n            };\n        });\n    },\n    sample_type: function(frm) {\n        // Clear the table if user changes sample type to avoid pricing errors\n        frm.clear_table('test_table');\n        frm.refresh_field('test_table');\n        frm.set_value('total_amount', 0);\n    }\n});\n\n// Logic inside the Child Table\nfrappe.ui.form.on('Soil Test Selection', {\n    test_item: function(frm, cdt, cdn) {\n        let row = locals[cdt][cdn];\n        if (row.test_item) {\n            // Fetch the rate from the Master DocType\n            frappe.db.get_value('Soil Test Package', row.test_item, 'rate', (r) => {\n                frappe.model.set_value(cdt, cdn, 'rate', r.rate);\n                calculate_total(frm);\n            });\n        }\n    },\n    test_table_remove: function(frm) {\n        calculate_total(frm);\n    }\n});\n\nfunction calculate_total(frm) {\n    let total = 0;\n    (frm.doc.test_table || []).forEach(row => {\n        total += row.rate;\n    });\n    frm.set_value('total_amount', total);\n}",
  "view": "Form"
 }
]